{% extends 'base.html' %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Nova Compra de D√≥lares</h4>
                </div>
                <div class="card-body">
                    <form method="post" id="compraForm">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <div class="mb-3">
                            <label for="data_compra_input" class="form-label">
                                <strong>Selecionar Data (dd/mm/aaaa)</strong>
                            </label>
                            <div class="input-group">
                                <input type="text" 
                                       name="data_compra_input" 
                                       id="data_compra_input"
                                       class="form-control" 
                                       placeholder="dd/mm/aaaa"
                                       required
                                       maxlength="10">
                                <button type="button" class="btn btn-outline-secondary" id="btnCalendario">
                                    üìÖ
                                </button>
                            </div>
                            <input type="hidden" name="data_compra" id="data_compra">
                            {% if form.data_compra.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.data_compra.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">Digite a data no formato dd/mm/aaaa ou clique no calend√°rio. Deve ser pelo menos 2 dias antes da data atual.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.quantidade_usd.id_for_label }}" class="form-label">
                                <strong>Quantidade de D√≥lares</strong>
                            </label>
                            {{ form.quantidade_usd }}
                            {% if form.quantidade_usd.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.quantidade_usd.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Resumo da Compra (ser√° preenchido via JavaScript) -->
                        <div class="card mb-3" id="resumoCompra" style="display: none;">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">Resumo da Compra</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6"><strong>Data:</strong></div>
                                    <div class="col-6" id="resumoData">-</div>
                                </div>
                                <div class="row">
                                    <div class="col-6"><strong>Quantidade USD:</strong></div>
                                    <div class="col-6" id="resumoQuantidade">-</div>
                                </div>
                                <div class="row">
                                    <div class="col-6"><strong>Cota√ß√£o USD/BRL:</strong></div>
                                    <div class="col-6" id="resumoCotacao">-</div>
                                </div>
                                <div class="row">
                                    <div class="col-6"><strong>Valor Total BRL:</strong></div>
                                    <div class="col-6" id="resumoTotal">-</div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-info btn-lg" id="btnCalcular">
                                Calcular Compra
                            </button>
                            <button type="submit" class="btn btn-success btn-lg" id="btnConfirmar" style="display: none;">
                                ‚úÖ Confirmar Compra
                            </button>
                            <a href="{% url 'home' %}" class="btn btn-secondary">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o -->
<div class="modal fade" id="modalConfirmacao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Confirmar Compra</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Voc√™ est√° prestes a comprar <strong id="modalQuantidade">-</strong> d√≥lares.</p>
                <div class="alert alert-info">
                    <strong>Resumo:</strong><br>
                    Data: <span id="modalData">-</span><br>
                    Quantidade: $ <span id="modalUSD">-</span><br>
                    Cota√ß√£o: R$ <span id="modalCotacao">-</span><br>
                    Total: R$ <span id="modalTotal">-</span>
                </div>
                <p class="mb-0">Deseja confirmar esta compra?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarModal">Confirmar Compra</button>
            </div>
        </div>
    </div>
</div>

<!-- Incluir jQuery, Datepicker e Bootstrap -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.pt-BR.min.js"></script>

<script>
$(document).ready(function() {
    const dataInput = $('#data_compra_input');
    const dataHidden = $('#data_compra');
    const quantidadeInput = $('#id_quantidade_usd');
    const form = $('#compraForm');
    const btnCalendario = $('#btnCalendario');
    const btnCalcular = $('#btnCalcular');
    const btnConfirmar = $('#btnConfirmar');
    const resumoCompra = $('#resumoCompra');
    const modalConfirmacao = new bootstrap.Modal(document.getElementById('modalConfirmacao'));

    // Calcular data m√°xima (2 dias antes de hoje)
    const hoje = new Date();
    const dataMaxima = new Date(hoje);
    dataMaxima.setDate(hoje.getDate() - 2);

    // Inicializar datepicker no input
    dataInput.datepicker({
        format: 'dd/mm/yyyy',
        language: 'pt-BR',
        autoclose: true,
        todayHighlight: true,
        endDate: dataMaxima,
        startDate: new Date('2020-01-01')
    });

    // Mostrar datepicker ao clicar no √≠cone do calend√°rio
    btnCalendario.click(function() {
        dataInput.datepicker('show');
    });

    // M√°scara de digita√ß√£o manual
    dataInput.on('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        
        if (value.length >= 3 && value.length <= 4) {
            value = value.substring(0, 2) + '/' + value.substring(2);
        } else if (value.length >= 5) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4) + '/' + value.substring(4, 8);
        }
        
        e.target.value = value;
    });

    // Bot√£o Calcular - Validar e mostrar resumo
    btnCalcular.click(function() {
        const dateValue = dataInput.val().trim();
        const quantidadeValue = parseFloat(quantidadeInput.val());
        
        // Validar dados b√°sicos
        if (!validarDados(dateValue, quantidadeValue)) {
            return;
        }

        // Buscar cota√ß√£o via AJAX
        buscarCotacao(dateValue, quantidadeValue);
    });

    // Validar dados do formul√°rio
    function validarDados(dateValue, quantidadeValue) {
        // Validar formato dd/mm/aaaa
        const dateRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
        if (!dateRegex.test(dateValue)) {
            alert('Por favor, insira uma data v√°lida no formato dd/mm/aaaa');
            dataInput.focus();
            return false;
        }

        const parts = dateValue.split('/');
        const dia = parseInt(parts[0]);
        const mes = parseInt(parts[1]);
        const ano = parseInt(parts[2]);

        // Validar se √© uma data v√°lida
        const dataObj = new Date(ano, mes - 1, dia);
        if (dataObj.getDate() !== dia || dataObj.getMonth() !== mes - 1 || dataObj.getFullYear() !== ano) {
            alert('Por favor, insira uma data v√°lida');
            dataInput.focus();
            return false;
        }

        // Validar se √© data futura ou muito recente
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        const dataMinimaValida = new Date(hoje);
        dataMinimaValida.setDate(hoje.getDate() - 2);
        
        if (dataObj >= dataMinimaValida) {
            alert('A data da compra deve ser pelo menos 2 dias antes da data atual (D-1).');
            dataInput.focus();
            return false;
        }

        // Validar quantidade
        if (!quantidadeValue || quantidadeValue <= 0) {
            alert('Por favor, insira uma quantidade v√°lida de d√≥lares.');
            quantidadeInput.focus();
            return false;
        }

        return true;
    }

    // Buscar cota√ß√£o via AJAX
    function buscarCotacao(dateValue, quantidadeValue) {
        const parts = dateValue.split('/');
        const dataFormatada = `${parts[2]}-${parts[1]}-${parts[0]}`;
        
        // Mostrar loading
        btnCalcular.html('<span class="spinner-border spinner-border-sm" role="status"></span> Buscando cota√ß√£o...');
        btnCalcular.prop('disabled', true);

        $.ajax({
            url: '{% url "cadastrar_compra" %}',
            type: 'POST',
            data: {
                'data_compra': dataFormatada,
                'quantidade_usd': quantidadeValue,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                'ajax_cotacao': true
            },
            success: function(response) {
                if (response.cotacao) {
                    mostrarResumo(dateValue, quantidadeValue, response.cotacao);
                } else {
                    alert('Erro ao buscar cota√ß√£o: ' + (response.error || 'Tente novamente.'));
                }
            },
            error: function() {
                alert('Erro ao conectar com o servidor. Tente novamente.');
            },
            complete: function() {
                btnCalcular.html('Calcular Compra');
                btnCalcular.prop('disabled', false);
            }
        });
    }

    // Mostrar resumo da compra
    function mostrarResumo(dateValue, quantidade, cotacao) {
        const total = quantidade * cotacao;
        
        // Atualizar resumo
        $('#resumoData').text(dateValue);
        $('#resumoQuantidade').text('$ ' + quantidade.toFixed(2));
        $('#resumoCotacao').text('R$ ' + cotacao.toFixed(4));
        $('#resumoTotal').text('R$ ' + total.toFixed(2));
        
        // Mostrar resumo
        resumoCompra.show();
        btnConfirmar.show();
        btnCalcular.hide();

        // Configurar dados para confirma√ß√£o
        dataHidden.val(dateValue.split('/').reverse().join('-'));
        
        // Mostrar modal de confirma√ß√£o
        $('#modalQuantidade').text('$ ' + quantidade.toFixed(2));
        $('#modalData').text(dateValue);
        $('#modalUSD').text(quantidade.toFixed(2));
        $('#modalCotacao').text(cotacao.toFixed(4));
        $('#modalTotal').text(total.toFixed(2));
        
        modalConfirmacao.show();
    }

    // Confirmar compra no modal
    $('#btnConfirmarModal').click(function() {
        modalConfirmacao.hide();
        form.submit();
    });

    // Focar no campo de data ao carregar a p√°gina
    dataInput.focus();
});
</script>

<style>
.datepicker {
    z-index: 1051 !important;
}
.datepicker-dropdown {
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.datepicker table tr td.today {
    background-color: #e6f7ff;
}
.datepicker table tr td.active.active {
    background-color: #007bff;
}
.input-group-text {
    cursor: pointer;
}
#resumoCompra .row {
    margin-bottom: 0.5rem;
    padding: 0.25rem 0;
    border-bottom: 1px solid #f0f0f0;
}
#resumoCompra .row:last-child {
    border-bottom: none;
    font-weight: bold;
    background-color: #f8f9fa;
}
</style>
{% endblock %}